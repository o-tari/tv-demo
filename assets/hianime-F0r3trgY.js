const u="hianime_cache_";class m{apiKey="";baseUrl="https://hianime.p.rapidapi.com";setApiKey(e){this.apiKey=e}clearCache(){Object.keys(localStorage).forEach(s=>{s.startsWith(u)&&localStorage.removeItem(s)})}getCacheKey(e,s){const t=s?JSON.stringify(s):"";return`${u}${e}_${t}`}getCachedData(e){try{const s=localStorage.getItem(e);if(!s)return null;const t=JSON.parse(s);return Date.now()>t.expiresAt?(localStorage.removeItem(e),null):t.data}catch(s){return console.error("Error reading from cache:",s),null}}setCachedData(e,s){try{const t=Date.now(),a={data:s,timestamp:t,expiresAt:t+36e5};localStorage.setItem(e,JSON.stringify(a))}catch(t){console.error("Error writing to cache:",t)}}async makeRequest(e,s){if(!this.apiKey)throw new Error("HiAnime API key is not set");const t=this.getCacheKey(e,s),a=this.getCachedData(t);if(a)return a;const r=new URL(`${this.baseUrl}${e}`);s&&Object.entries(s).forEach(([n,d])=>{r.searchParams.append(n,String(d))});const i=await fetch(r.toString(),{method:"GET",headers:{"x-rapidapi-host":"hianime.p.rapidapi.com","x-rapidapi-key":this.apiKey}});if(!i.ok)throw new Error(`HiAnime API error: ${i.status} ${i.statusText}`);const o=await i.json();return this.setCachedData(t,o),o}async getHomeData(){return(await this.makeRequest("/anime/home")).data}async getAnimeInfo(e){return(await this.makeRequest("/anime/info",{id:e})).data}async searchAnime(e,s){const t={q:e};return s&&Object.entries(s).forEach(([r,i])=>{i!=null&&i!==""&&(t[r]=i)}),(await this.makeRequest("/anime/search",t)).data}async getAnimeEpisodes(e){return(await this.makeRequest(`/anime/episodes/${e}`)).data}async getEpisodeServers(e){return(await this.makeRequest("/anime/servers",{episodeId:e})).data}async getEpisodeSources(e,s,t="sub"){const a=this.getServerName(s);return(await this.makeRequest("/anime/episode-srcs",{id:e,server:a,category:t})).data}async getEpisodeStreamingUrl(e,s,t="sub"){try{const n=await this.getEpisodeSources(e,s,t);if(n.sources&&n.sources.length>0){const d=e.replace(/\?ep=\d+/,""),c=this.getServerName(s),b=this.extractEpisodeNumber(e),p=`https://hianime.to/embed/${d}?ep=${b}&server=${c}&category=${t}`;return console.log("Created HiAnime embed URL with sources data:",p),{url:p,isEmbed:!0,sources:n}}}catch(n){console.warn("Failed to get episode sources, falling back to embed URL:",n)}const a=e.replace(/\?ep=\d+/,""),r=this.getServerName(s),i=this.extractEpisodeNumber(e),o=`https://hianime.to/embed/${a}?ep=${i}&server=${r}&category=${t}`;return console.log("Created HiAnime embed URL (fallback):",o),{url:o,isEmbed:!0}}getServerName(e){return{1:"hd-2",4:"hd-1",6:"hd-3"}[e]||"hd-1"}extractEpisodeNumber(e){const s=e.match(/\?ep=(\d+)/);return s?s[1]:"1"}convertSpotlightToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",description:e.description,jname:e.jname,rank:e.rank,episodes:e.episodes,otherInfo:e.otherInfo,totalEpisodes:e.episodes.sub||e.episodes.dub||0,subOrDub:e.episodes.sub?"sub":"dub",animeType:e.otherInfo?.[0]||"TV",duration:e.otherInfo?.[1]||"24m",rating:e.otherInfo?.[3]||"HD"}}convertTrendingToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",rank:e.rank}}convertLatestEpisodeToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",duration:e.duration,animeType:e.type,rating:e.rating||void 0,episodes:e.episodes,totalEpisodes:e.episodes.sub||e.episodes.dub||0,subOrDub:e.episodes.sub?"sub":"dub"}}convertUpcomingToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",duration:e.duration,animeType:e.type,rating:e.rating||void 0,episodes:e.episodes,totalEpisodes:e.episodes.sub||e.episodes.dub||0,subOrDub:e.episodes.sub?"sub":"dub"}}convertTop10ToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",rank:e.rank,episodes:e.episodes,totalEpisodes:e.episodes.sub||e.episodes.dub||0,subOrDub:e.episodes.sub?"sub":"dub"}}convertTopAiringToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",description:"",jname:e.jname,otherInfo:e.otherInfo,animeType:e.otherInfo?.[0]||"TV",totalEpisodes:0,subOrDub:"sub",episodes:{sub:0,dub:0},anilistId:void 0,malId:void 0,duration:void 0,rating:void 0}}convertInfoToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",description:e.description,anilistId:e.anilistId,malId:e.malId,episodes:e.stats.episodes,totalEpisodes:e.stats.episodes.sub||e.stats.episodes.dub||0,subOrDub:e.stats.episodes.sub?"sub":"dub",animeType:e.stats.type,duration:e.stats.duration,rating:e.stats.rating}}convertMostPopularToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",description:"",anilistId:void 0,malId:void 0,episodes:e.episodes,totalEpisodes:e.episodes.sub||e.episodes.dub||0,subOrDub:e.episodes.sub?"sub":"dub",animeType:e.type,duration:void 0,rating:void 0}}convertMostFavoriteToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",description:"",anilistId:void 0,malId:void 0,episodes:e.episodes,totalEpisodes:e.episodes.sub||e.episodes.dub||0,subOrDub:e.episodes.sub?"sub":"dub",animeType:e.type,duration:void 0,rating:void 0}}convertLatestCompletedToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",description:"",anilistId:void 0,malId:void 0,episodes:e.episodes,totalEpisodes:e.episodes.sub||e.episodes.dub||0,subOrDub:e.episodes.sub?"sub":"dub",animeType:e.type,duration:void 0,rating:void 0}}convertSeasonToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",description:e.title,animeType:"TV",totalEpisodes:0,subOrDub:"sub"}}convertRelatedAnimeToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",jname:e.jname,episodes:e.episodes,totalEpisodes:e.episodes.sub||e.episodes.dub||0,subOrDub:e.episodes.sub?"sub":"dub",animeType:e.type}}convertRecommendedAnimeToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",jname:e.jname,episodes:e.episodes,totalEpisodes:e.episodes.sub||e.episodes.dub||0,subOrDub:e.episodes.sub?"sub":"dub",animeType:e.type,duration:e.duration,rating:e.rating||void 0}}convertSearchAnimeToMedia(e){return{id:e.id,title:e.name,image:e.poster,url:`/hianime/${e.id}`,type:"hianime",jname:e.jname,episodes:e.episodes,totalEpisodes:e.episodes.sub||e.episodes.dub||0,subOrDub:e.episodes.sub?"sub":"dub",animeType:e.type,duration:e.duration,rating:e.rating||void 0}}getCacheInfo(){try{const s=Object.keys(localStorage).filter(r=>r.startsWith(u));let t=0;const a=Date.now();return s.forEach(r=>{try{const i=localStorage.getItem(r);if(i){const o=JSON.parse(i);a>o.expiresAt&&t++}}catch{t++}}),{totalKeys:s.length,expiredKeys:t}}catch(e){return console.error("Error getting cache info:",e),{totalKeys:0,expiredKeys:0}}}}const l=new m;export{l as h};
